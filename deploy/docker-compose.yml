version: '3.8'

services:
  plab-rundown:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: plab-rundown
    restart: unless-stopped

    # 环境变量 (从 .env 文件加载)
    env_file:
      - ../.env

    # 端口映射
    ports:
      - "10000:10000"  # 健康检查端口

    # 网络模式 (允许访问宿主机的 Clash 代理)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # 数据卷挂载
    volumes:
      - ../logs:/app/logs
      - ../data:/app/data
      - ../credentials:/app/credentials
      - ../config:/app/config
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 可选: 如果需要使用 PostgreSQL 数据库
#  postgres:
#    image: postgres:15-alpine
#    container_name: plab-rundown-db
#    restart: unless-stopped
#    environment:
#      POSTGRES_DB: plab_rundown
#      POSTGRES_USER: plab_user
#      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
#    volumes:
#      - postgres_data:/var/lib/postgresql/data
#    ports:
#      - "5432:5432"

#volumes:
#  postgres_data:

